{{ asset.presentation_params|json_script:"presentation-params" }}
{{ asset.camera|json_script:"camera-data" }}
<style>
    .lil-gui {
        --title-background-color: rgba(0,0,0,0.25);
        --background-color: rgba(0,0,0,0.25);
        --widget-color: rgba(1,1,1,0.25);
    }
    .lil-gui.root {
        position: absolute;
        top: 0;
        right: 0;
    }
</style>
<style>
    #icosa-wrapper {
        display: flex;
    }
    #icosa-viewer {
        flex-grow: 1;
    }
    #tree-view {
        padding: 10px;
        background-color: rgba(0,0,0,0.25);
        color: white;
        font-size: 11px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        z-index: 10;
        display: none;
        width: 250px;
        overflow-y: auto;
        flex-shrink: 0;
    }
    .tree-node {
        margin: 5px 0;
        white-space: nowrap;
    }
    .tree-content {
        align-items: center;
    }
    #tree-view .toggle-btn {
        display: inline-block;
        cursor: pointer;
        width: 10px;
        text-align: center;
        margin-right: 5px;
    }
    #tree-view .children {
        margin-left: 10px;
        display: none;
    }
    #tree-view .selected {
        background-color: rgba(255,255,255,0.5);
        color: black;
    }
    #tree-view .expanded > .children {
        display: block;
    }
    #tree-view input[type="checkbox"] {
        display: inline;
        margin: 0;
    }
</style>
<script type="importmap" class="es6_modules_map">
    {
        "imports": {
    {% if request.session.viewer_js_version == "previous" %}
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.0/examples/jsm/",
		"three/examples/": "https://cdn.jsdelivr.net/npm/three@0.164.0/examples/"
    {% else %}
        "three": "https://cdn.jsdelivr.net/npm/three@0.172.0/build/three.module.js",
		"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.172.0/examples/jsm/",
		"three/examples/": "https://cdn.jsdelivr.net/npm/three@0.172.0/examples/",
        {% if request.session.viewer_js_version == "experimental" %}
            "three-icosa": "/static/js-experimental/three-icosa.module.js?v={% now "U" %}",
        {% else %}
            "three-icosa": "/static/js/three-icosa.module.js?v={% now "U" %}",
        {% endif %}
		"three-tiltloader": "https://cdn.jsdelivr.net/npm/three-tiltloader@0.4.2-alpha.4/dist/three-tiltloader.module.js",
		"@sparkjsdev/spark": "https://cdn.jsdelivr.net/gh/sparkjsdev/spark@b60e9d9acbe621e67eda5d98417fcfdea5af6291/dist/spark.module.js"
    {% endif %}
        }
    }
</script>
<script type="module">

    {% if request.session.viewer_js_version == "previous" %}
        import { Viewer } from "/static/js-previous/icosa-viewer.module.js?v={% now "U" %}";
    {% elif request.session.viewer_js_version == "experimental" %}
        import { Viewer } from "/static/js-experimental/icosa-viewer.module.js?v={% now "U" %}";
        import * as THREE from "three";
    {% else %}
        import { Viewer } from "/static/js/icosa-viewer.module.js?v={% now "U" %}";
        import * as THREE from "three";
    {% endif %}

    import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

    {% if request.session.viewer_js_version == "experimental" %}
        var viewer = new Viewer("{{ settings.BRUSHES_STATIC_URL }}-experimental/");
    {% elif request.session.viewer_js_version == "previous" %}
        var viewer = new Viewer("{{ settings.BRUSHES_STATIC_URL }}-previous/");
    {% else %}
        var viewer = new Viewer("{{ settings.BRUSHES_STATIC_URL }}/");
    {% endif %}

    let presentationParams = JSON.parse(document.getElementById('presentation-params').textContent);
    let cameraSettings = presentationParams?.camera || {};
    let cameraOverrides = JSON.parse(document.getElementById('camera-data').textContent);
    cameraSettings = { ...cameraSettings, ...cameraOverrides };
    let overrides = {
        'defaultBackgroundColor': presentationParams?.backgroundColor || "#000000",
        'camera': cameraSettings,
        'geometryData': presentationParams?.geometry_data || presentationParams?.GOOGLE_geometry_data || {},
        'colorSpace': presentationParams?.colorSpace || "LINEAR",
    };

    // For debugging
    window.viewer = viewer;
    window.THREE = THREE;

    {% if format_override %}
        let formatType = "{{ format_override }}".toLowerCase();
    {% else %}
        let formatType = "{{ asset.preferred_viewer_format.format_type }}".toLowerCase();
    {% endif %}

    let url = "{{ asset.preferred_viewer_format.root_resource.internal_or_cors_url }}";


    if (formatType === 'gltf2' || formatType === 'glb') {
        try {
            console.log("Trying to load as GLTF2");
            await viewer.loadGltf(url, true, overrides);
            if (viewer.loadingError == true)
            {
                throw new Error("GLTF2 loading error");
            }
        } catch (error) {
            console.log(error);
            console.log("GLTF2 failed. Trying to load as GLTF1");
            await viewer.loadGltf1(url, true, overrides);
        }
    } else if (formatType === 'gltf1') {
        try {
            console.log("Trying to load as GLTF1");
            await viewer.loadGltf1(url, true, overrides);
            if (viewer.loadingError == true)
            {
                throw new Error("GLTF1 loading error");
            }

        } catch (error) {
            console.log(error);
            console.log("GLTF1 failed. Trying to load as GLTF2");
            await viewer.loadGltf(url, true, overrides);
        }
    } else if (formatType === 'fbx') {
        console.log("Trying to load fbx");
        await viewer.loadFbx(url, overrides);
    } else if (formatType === 'obj') {
        console.log("Trying to load obj");
        {% with mtl_resource=asset.preferred_viewer_format.resource_set.first %}
            {% if mtl_resource %}
                let mtlUrl = "{{ mtl_resource.url|default_if_none:'' }}";
                await viewer.loadObjWithMtl(url, mtlUrl, overrides);
            {% else %}
                await viewer.loadObj(url, overrides);
            {% endif %}
        {% endwith %}
    // PLYs are now assumed to be Gaussian splats
    // TODO allow override?
    // } else if (formatType === 'ply') {
    //     console.log("Trying to load ply");
    //     await viewer.loadPly(url, overrides);
    } else if (formatType === 'stl') {
        console.log("Trying to load stl");
        await viewer.loadStl(url, overrides);
    } else if (formatType === 'usdz') {
        console.log("Trying to load usdz");
        await viewer.loadUsdz(url, overrides);
    } else if (formatType === 'vox') {
        console.log("Trying to load vox");
        await viewer.loadVox(url, overrides);
    } else if (formatType === 'ply' || formatType === 'sog' || formatType === 'spz' || formatType === 'splat' || formatType === 'ksplat') {
        console.log("Trying to load Gaussian splat");
        await viewer.loadSplat(url, overrides);
    } else {
        console.error("Unsupported file format: " + formatType);
    }


    // Add lil-gui controls

    const gui = new GUI({ autoPlace: false }); // Prevent automatic placement
    const parentDiv = document.getElementById('icosa-viewer');
    parentDiv.appendChild(gui.domElement);
    gui.close();

    const guiParams = {
        toggleTreeView: () => viewer.toggleTreeView(document.getElementById('tree-view')),
        toggleEnvironment: () => viewer.environmentObject && (viewer.environmentObject.visible = !viewer.environmentObject.visible),
        toggleSky: () => viewer.skyObject && (viewer.skyObject.visible = !viewer.skyObject.visible),
        levelCamera: () => {
            viewer.levelCamera();
        },
        frameScene: () => {
            viewer.frameScene();
        },
        wireframe: () => {
            viewer.scene.traverse((child) => {
                if (child instanceof THREE.Mesh && child !== viewer.skyObject) {
                    child.material.wireframe = !child.material.wireframe;
                }
            });
        },
        stochastic: false,
        // Lighting controls
        ambientLightColor: '#ffffff',
        light0Color: '#ffffff',
        light0RotationX: 0,
        light0RotationY: 0,
        light1Color: '#ffffff',
        light1RotationX: 0,
        light1RotationY: 0
    };

    const toggleTreeView = gui.add(guiParams, 'toggleTreeView').name("Hierarchy Panel");
    const toggleEnvironmentControl = gui.add(guiParams, 'toggleEnvironment').name("Toggle Environment");
    const toggleSkyControl = gui.add(guiParams, 'toggleSky').name("Toggle Sky");
    const levelCameraControl = gui.add(guiParams, 'levelCamera').name("Level Camera");
    const frameSceneControl = gui.add(guiParams, 'frameScene').name("Frame Scene");
    const wireframeControl = gui.add(guiParams, 'wireframe').name("Toggle Wireframe");

    const stochasticControl = gui.add(guiParams, 'stochastic').name("Splat Stochastic Rendering").onChange(() => {
        viewer.scene.traverse((child) => {
            if (child.constructor.name.includes('Spark') && child.defaultView) {
                child.defaultView.stochastic = guiParams.stochastic;
            }
        });
    });

    // Lighting controls folder
    const lightsFolder = gui.addFolder('Lighting');

    // Get references to lights after model is loaded
    let ambientLight = null;
    let directionalLight0 = null;
    let directionalLight1 = null;

    viewer.scene.traverse((child) => {
        if (child instanceof THREE.AmbientLight) {
            ambientLight = child;
        } else if (child instanceof THREE.DirectionalLight) {
            if (!directionalLight0) {
                directionalLight0 = child;
            } else if (!directionalLight1) {
                directionalLight1 = child;
            }
        }
    });

    // Ambient light color control
    if (ambientLight) {
        guiParams.ambientLightColor = '#' + ambientLight.color.getHexString();
        lightsFolder.addColor(guiParams, 'ambientLightColor').name('Ambient Light Color').onChange(() => {
            ambientLight.color.setHex(parseInt(guiParams.ambientLightColor.replace('#', ''), 16));
        });
    }

    // Directional Light 0 controls
    if (directionalLight0) {
        guiParams.light0Color = '#' + directionalLight0.color.getHexString();
        const light0Euler = new THREE.Euler().setFromQuaternion(directionalLight0.quaternion);
        guiParams.light0RotationX = THREE.MathUtils.radToDeg(light0Euler.x);
        guiParams.light0RotationY = THREE.MathUtils.radToDeg(light0Euler.y);

        const light0Folder = lightsFolder.addFolder('Light 0');
        light0Folder.close();
        light0Folder.addColor(guiParams, 'light0Color').name('Color').onChange(() => {
            directionalLight0.color.setHex(parseInt(guiParams.light0Color.replace('#', ''), 16));
        });
        light0Folder.add(guiParams, 'light0RotationX', -180, 180).name('Rotation X').onChange(() => {
            const euler = new THREE.Euler(
                THREE.MathUtils.degToRad(guiParams.light0RotationX),
                THREE.MathUtils.degToRad(guiParams.light0RotationY),
                0
            );
            const direction = new THREE.Vector3(0, 0, 1).applyEuler(euler);
            directionalLight0.position.copy(direction.multiplyScalar(10));
            directionalLight0.lookAt(0, 0, 0);
        });
        light0Folder.add(guiParams, 'light0RotationY', -180, 180).name('Rotation Y').onChange(() => {
            const euler = new THREE.Euler(
                THREE.MathUtils.degToRad(guiParams.light0RotationX),
                THREE.MathUtils.degToRad(guiParams.light0RotationY),
                0
            );
            const direction = new THREE.Vector3(0, 0, 1).applyEuler(euler);
            directionalLight0.position.copy(direction.multiplyScalar(10));
            directionalLight0.lookAt(0, 0, 0);
        });
    }

    // Directional Light 1 controls
    if (directionalLight1) {
        guiParams.light1Color = '#' + directionalLight1.color.getHexString();
        const light1Euler = new THREE.Euler().setFromQuaternion(directionalLight1.quaternion);
        guiParams.light1RotationX = THREE.MathUtils.radToDeg(light1Euler.x);
        guiParams.light1RotationY = THREE.MathUtils.radToDeg(light1Euler.y);

        const light1Folder = lightsFolder.addFolder('Light 1');
        light1Folder.close();
        light1Folder.addColor(guiParams, 'light1Color').name('Color').onChange(() => {
            directionalLight1.color.setHex(parseInt(guiParams.light1Color.replace('#', ''), 16));
        });
        light1Folder.add(guiParams, 'light1RotationX', -180, 180).name('Rotation X').onChange(() => {
            const euler = new THREE.Euler(
                THREE.MathUtils.degToRad(guiParams.light1RotationX),
                THREE.MathUtils.degToRad(guiParams.light1RotationY),
                0
            );
            const direction = new THREE.Vector3(0, 0, 1).applyEuler(euler);
            directionalLight1.position.copy(direction.multiplyScalar(10));
            directionalLight1.lookAt(0, 0, 0);
        });
        light1Folder.add(guiParams, 'light1RotationY', -180, 180).name('Rotation Y').onChange(() => {
            const euler = new THREE.Euler(
                THREE.MathUtils.degToRad(guiParams.light1RotationX),
                THREE.MathUtils.degToRad(guiParams.light1RotationY),
                0
            );
            const direction = new THREE.Vector3(0, 0, 1).applyEuler(euler);
            directionalLight1.position.copy(direction.multiplyScalar(10));
            directionalLight1.lookAt(0, 0, 0);
        });
    }

    if (!viewer.environmentObject) toggleEnvironmentControl.disable();
    if (!viewer.skyObject) toggleSkyControl.disable();

</script>
