{% extends "base.html" %}
{% load fontawesome_tags %}
{% load static %}
{% load paginator_tags %}

{% block extrahead %}
    {{ block.super }}
    <link rel="canonical" href="{% clean_url %}">
{% endblock extrahead %}

{% block content %}
<div class="container">
</div>
<div class="container">
    <div id="messagecontainer">
    <ul class="messages" id="id_upload_success_messages" hidden>
        <li class="info"></li>
    </ul>
    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    </div>
    <div class="row">
        <div class="col">
            <h1>{{ page_title }}</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-6">
            <h1>Upload New File</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-6">
            <form id="id_upload_form" action="{% url 'icosa:upload_asset' %}" class="file-form" method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                <ul class="errorlist" id="id_file_error" hidden></ul>
                <input multiple type="file" class="form-control-file" name="file" id="uploadfile" required>
                <button id="id_upload_submit" type="submit" class="btn btn-primary">Upload</button><span id="id_upload_spinner" hidden style="margin-inline-start:1em;">{% fa_icon "solid" "arrows-rotate" "fa-spin" %}&nbsp;Uploading files</span>
            </form>
        </div>
        <div class="col-lg-6">
                <details>
                    <summary>
                        Note: We support the following formats:
                    </summary>
                    <div class="details-content">
                        <ul>
                            <li>gltf (+bin)</li>
                            <li>glb</li>
                            <li>tilt</li>
                            <li>blocks</li>
                            <li>fbx (+fbm)</li>
                            <li>obj (+mtl)</li>
                            <li>stl</li>
                            <li>usdz</li>
                            <li>vox</li>
                            <li>ply</li>
                            <li>sog</li>
                            <li>spz</li>
                            <li>splat</li>
                            <li>ksplat</li>
                        </ul>
                    </div>
                </details>
            <p>
                Currently you can upload a zip file containing all relevant files.
                <br>
                (For example, if uploading <code>sketch.gltf</code>, make sure <code>sketch.bin</code> is
                also included in the zip file.)
                <br>
                <strong>or</strong> you can upload a glb file.
            </p>
            <p>You can create a thumbnail after uploading by editing your work's settings.</p>
            {% if config.BETA_MODE %}
                <p><strong>This site is currently in Beta mode. While we will do our best to keep things stable, your data may be removed at any time. Please bear this in mind when uploading your work.</strong></p>
            {% endif %}
        </div>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col">
            <h2>Manage Uploads</h2>
        </div>
    </div>
    <div id="id_uploads_container">
        {% include "partials/asset_upload_list.html" %}
    </div>
</div>
<script>
    const form = id_upload_form;
    async function handleUploadForm() {
        id_upload_submit.setAttribute("disabled", true)
        id_upload_spinner.removeAttribute("hidden")
        id_file_error.setAttribute("hidden", true);
        const data = new FormData(form);
        file = data.get("file");
        filesize = file.size; // Use this later to handle uploads which are too large. 
        try {
            const response = await fetch(form.action, {
                method: "POST",
                body: data,
            });
            const resData = await response.json();
            id_upload_spinner.setAttribute("hidden", true);
            id_upload_submit.removeAttribute("disabled")
            if (resData.success === true) {
                id_upload_success_messages.removeAttribute("hidden");
                id_upload_success_messages.querySelector("li").textContent = resData.message;
                htmx.ajax("GET", "{% url 'icosa:upload_list_partial' %}", "#id_uploads_container");
            } else {
                const errors = resData.errors;
                if (errors.hasOwnProperty("file")) {
                    id_file_error.removeAttribute("hidden");
                    id_file_error.replaceChildren();
                    let itemHtml;
                    errors.file.forEach((item) => {
                        itemHtml = document.createElement("li");
                        itemHtml.textContent = item
                        id_file_error.appendChild(itemHtml);
                    })
                }
            }
        } catch (e) {
            console.error(e);
        }
        uploadfile.value = null;
    }
    form.addEventListener("submit", (event) =>{
        event.preventDefault();
        handleUploadForm();
    })
</script>
{% endblock content %}
